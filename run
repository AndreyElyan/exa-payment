#!/usr/bin/env bash
export USERID="$(id -u)"

NPM="npm"
NEST="npx nest"
NPX="npx"
ENV_FILE=".env"
ENV_FILE_EXAMPLE=".env.example"
ICON="ü§ñ"

project_dir=$(pwd)

show_commands () {
    echo
    echo "$ICON Comandos dispon√≠veis:"
    echo
    echo "sh run start-app api     - Inicia a API em modo Dev"
    echo "sh run debug api         - Inicia a API em modo debug"
    echo "sh run build             - Builda a aplica√ß√£o"
    echo "sh run test              - Executa todos os testes"
    echo "sh run test:unit         - Executa testes unit√°rios"
    echo "sh run test:e2e          - Executa testes e2e"
    echo "sh run test:cov          - Executa testes com cobertura"
    echo "sh run test:watch        - Executa testes em modo watch"
    echo "sh run lint              - Executa lint"
    echo "sh run format            - Formata c√≥digo"
    echo "sh run docker:up         - Sobe infraestrutura Docker"
    echo "sh run docker:down       - Para infraestrutura Docker"
    echo "sh run prisma:generate   - Gera cliente Prisma"
    echo "sh run prisma:migrate    - Executa migra√ß√µes do banco"
    echo "sh run prisma:seed       - Executa seed do banco"
    echo "sh run prisma:studio     - Abre Prisma Studio"
    echo
}

devops_start () {
    echo "$ICON Iniciando infraestrutura Docker..."
    npm run docker:up
}

execute_npm_install () {
    echo "$ICON Instalando depend√™ncias..."
    npm install
}

start_app () {
    APP=$2

    if [ -z "$APP" ] || [ "$APP" != "api" ]; then
        echo "$ICON Use: sh run start-app api"
        exit 1
    fi

    devops_start
    execute_npm_install

    echo "$ICON Iniciando API em modo desenvolvimento..."
    npx nest start api --watch
}

debug () {
    APP=$2

    if [ -z "$APP" ] || [ "$APP" != "api" ]; then
        echo "$ICON Use: sh run debug api"
        exit 1
    fi

    devops_start
    execute_npm_install

    echo "$ICON Iniciando API em modo debug..."
    npx nest start api --debug
}

build_app () {
    echo "$ICON Buildando aplica√ß√£o..."
    npm run build
}

test_app () {
    echo "$ICON Executando todos os testes..."
    DATABASE_URL=postgresql://app:app@localhost:5434/payments npm run test
}

test_unit () {
    echo "$ICON Executando testes unit√°rios..."
    DATABASE_URL=postgresql://app:app@localhost:5434/payments npm run test:unit
}

test_e2e () {
    echo "$ICON Executando testes e2e..."
    DATABASE_URL=postgresql://app:app@localhost:5434/payments npm run test:e2e
}

test_coverage () {
    echo "$ICON Executando testes com cobertura..."
    DATABASE_URL=postgresql://app:app@localhost:5434/payments npm run test:cov
}

test_watch () {
    echo "$ICON Executando testes em modo watch..."
    DATABASE_URL=postgresql://app:app@localhost:5434/payments npm run test:watch
}

lint_app () {
    echo "$ICON Executando lint..."
    npm run lint
}

format_app () {
    echo "$ICON Formatando c√≥digo..."
    npm run format
}

docker_up () {
    echo "$ICON Subindo infraestrutura Docker..."
    npm run docker:up
}

docker_down () {
    echo "$ICON Parando infraestrutura Docker..."
    npm run docker:down
}

prisma_generate () {
    echo "$ICON Gerando cliente Prisma..."
    npx prisma generate --schema=apps/api/prisma/schema.prisma
}

prisma_migrate () {
    echo "$ICON Executando migra√ß√µes do banco..."
    npx prisma migrate dev --schema=apps/api/prisma/schema.prisma
}

prisma_seed () {
    echo "$ICON Executando seed do banco..."
    npx prisma db seed --schema=apps/api/prisma/schema.prisma
}

prisma_studio () {
    echo "$ICON Abrindo Prisma Studio..."
    npx prisma studio --schema=apps/api/prisma/schema.prisma
}

if [ $# -gt 0 ]; then
    case "$1" in
      "start-app") start_app "$@" ;;
      "debug") debug "$@" ;;
      "build") build_app "$@" ;;
      "test") test_app "$@" ;;
      "test:unit") test_unit "$@" ;;
      "test:e2e") test_e2e "$@" ;;
      "test:cov") test_coverage "$@" ;;
      "test:watch") test_watch "$@" ;;
      "lint") lint_app "$@" ;;
      "format") format_app "$@" ;;
      "docker:up") docker_up "$@" ;;
      "docker:down") docker_down "$@" ;;
      "prisma:generate") prisma_generate "$@" ;;
      "prisma:migrate") prisma_migrate "$@" ;;
      "prisma:seed") prisma_seed "$@" ;;
      "prisma:studio") prisma_studio "$@" ;;
    *) show_commands ;;
    esac
else
    show_commands
fi
